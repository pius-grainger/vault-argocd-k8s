# ArgoCD + Vault Architecture Guide

## Overview

This architecture implements a secure, scalable GitOps workflow using ArgoCD with HashiCorp Vault for centralized secret management across multiple Kubernetes namespaces.

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    Git Repository                            │
│         (ArgoCD Application Manifests & Configs)             │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      ArgoCD Server                            │
│              (GitOps Orchestration)                           │
│  Namespace: argocd                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
                ▼            ▼            ▼
        ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
        │  Vault       │ │  ESO         │ │  Application │
        │  (Secrets)   │ │  (Sync)      │ │  Namespace   │
        │  namespace   │ │  namespace   │ │  (Production)│
        └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
               │                │                │
               │ HTTP/TLS       │ Native K8s API │
               └────────┬───────┴────────┬───────┘
                        │                │
                        ▼                ▼
              ┌──────────────────────────────────┐
              │   ClusterSecretStore             │
              │   (Vault Backend)                │
              └──────────────────────────────────┘
                        │
                        ▼
              ┌──────────────────────────────────┐
              │  ExternalSecret Resources        │
              │  (Per Namespace)                 │
              │  - production                    │
              │  - staging                       │
              │  - development                   │
              └──────────────────────────────────┘
                        │
                        ▼
              ┌──────────────────────────────────┐
              │  Kubernetes Secrets              │
              │  (Automatically Created/Synced)  │
              └──────────────────────────────────┘
```

## Key Components

### 1. Vault (Secrets Backend)
- **Role**: Centralized secret storage and management
- **Namespace**: `vault`
- **Storage**: Can use file storage (dev) or Raft (HA production)
- **Auth Method**: Kubernetes auth for service accounts
- **Key Features**:
  - Secret versioning (KV V2)
  - Encryption at rest
  - Audit logging
  - Policy-based access control

### 2. ArgoCD (GitOps Operator)
- **Role**: Declarative application deployment from Git
- **Namespace**: `argocd`
- **Key Features**:
  - Continuous synchronization with Git
  - Application health monitoring
  - Multi-cluster support
  - RBAC and SSO integration
  - Helm and Kustomize support

### 3. External Secrets Operator (ESO)
- **Role**: Bridge between Vault and Kubernetes Secrets
- **Namespace**: `external-secrets`
- **Key Features**:
  - Automatic secret syncing
  - Multi-backend support (Vault, AWS Secrets Manager, etc.)
  - Refresh intervals
  - Template support
  - Namespace isolation

### 4. Application Namespaces
- **Namespaces**: `production`, `staging`, `development`
- **Resources**:
  - `ExternalSecret` definitions
  - Kubernetes `Secret` objects (auto-generated by ESO)
  - Application deployments
  - Services and Ingresses

## Secret Management Workflows

### Workflow 1: External Secrets Operator (Recommended)

**When to use**: Most common scenario for GitOps with Vault

```
Vault (Secret Source)
      ↓
ExternalSecret (K8s CRD)
      ↓
Kubernetes Secret
      ↓
Application (via env/volume mount)
```

**Advantages**:
- Declarative in Git
- Automatic synchronization
- Per-namespace control
- Built-in templating

**Example**:
```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-secrets
  namespace: production
spec:
  secretStoreRef:
    name: vault-backend
  target:
    name: app-secrets
  data:
  - secretKey: db-password
    remoteRef:
      key: databases/postgres
      property: password
```

### Workflow 2: Vault Agent Injector

**When to use**: Dynamic secret injection at pod startup

```
Vault (Secret Source)
      ↓
Vault Agent Sidecar
      ↓
Application Container
      ↓
/vault/secrets (mounted volume)
```

**Advantages**:
- Automatic pod annotation injection
- Short-lived tokens
- Template rendering
- No StatefulSet needed

**Example**:
```yaml
annotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "application"
  vault.hashicorp.com/agent-inject-secret-db: "secret/databases/postgres"
```

### Workflow 3: Sealed Secrets (Optional - Git-Safe)

**When to use**: Additional layer for Git storage

```
Vault (Secret Source)
      ↓
Secret (encrypted for Git)
      ↓
Sealed Secrets Controller (decrypt)
      ↓
Kubernetes Secret
      ↓
Application
```

## Authentication & Authorization

### Kubernetes Auth Method

```
┌─────────────────────────────────┐
│  Kubernetes Cluster             │
│  ┌───────────────────────────┐  │
│  │ ServiceAccount            │  │
│  │ (external-secrets-vault)  │  │
│  └────────────┬──────────────┘  │
│               │ JWT Token       │
│               ▼                 │
│  ┌───────────────────────────┐  │
│  │ K8s TokenReview API       │  │
│  └────────────┬──────────────┘  │
│               │                 │
└───────────────┼─────────────────┘
                │
                ▼
        ┌──────────────────┐
        │ Vault Server     │
        │ - Validate JWT   │
        │ - Issue token    │
        │ - Apply policy   │
        └──────────────────┘
```

### Vault Policy Example

```hcl
path "secret/data/applications/*" {
  capabilities = ["read", "list"]
}

path "secret/metadata/applications/*" {
  capabilities = ["read", "list"]
}
```

## Multi-Namespace Secret Distribution

### Scenario: Deploy same app to 3 environments

#### Option 1: Individual ExternalSecrets per namespace

```
Git Repository
├── external-secrets/
│   ├── production/
│   │   └── app-secrets.yaml
│   ├── staging/
│   │   └── app-secrets.yaml
│   └── development/
│       └── app-secrets.yaml
```

#### Option 2: ApplicationSet for automation

```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: external-secrets-multienv
spec:
  generators:
  - list:
      elements:
      - namespace: production
      - namespace: staging
      - namespace: development
  template:
    spec:
      source:
        path: external-secrets/{{namespace}}
      destination:
        namespace: {{namespace}}
```

## Security Considerations

### 1. Network Security
- Use TLS for all Vault communications
- Implement network policies to restrict pod-to-pod traffic
- Use service mesh (Istio) for mTLS

### 2. RBAC & Authorization
- Implement least-privilege policies in Vault
- Use separate roles for each application
- Audit all secret access

### 3. Secret Rotation
```yaml
# Automatic refresh
spec:
  refreshInterval: 1h  # Resync every hour
```

### 4. Git Security
- Never commit secrets to Git
- Use Sealed Secrets or Vault-managed templates
- Enable branch protection rules
- Audit all Git changes

### 5. Vault High Availability
```yaml
storage "raft" {
  path = "/vault/data"
}

listener "tcp" {
  address = "0.0.0.0:8200"
  tls_disable = 0
}
```

## Disaster Recovery

### Backup Strategy
1. **Vault State**: Regular snapshots of KV secrets
2. **Configuration**: ArgoCD app configs backed up in Git
3. **ExternalSecret Definitions**: Stored in Git (no secrets)

### Recovery Procedure
1. Restore Vault from backup
2. Re-create cluster from ArgoCD
3. ESO automatically syncs secrets from restored Vault

## Performance Optimization

### 1. Caching
- ESO caches secrets locally
- Set appropriate `refreshInterval`

### 2. Resource Allocation
```yaml
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi
```

### 3. Multiple ESO Replicas
```yaml
replicaCount: 2  # For load distribution
```

## Troubleshooting Guide

| Issue | Cause | Solution |
|-------|-------|----------|
| ExternalSecret pending | Vault unreachable | Check network connectivity, TLS certs |
| Auth failures | Wrong Vault policy | Review Vault policy and K8s auth role |
| Secrets not updating | Low refresh interval | Increase `refreshInterval` |
| Pod startup fails | Secret not found | Verify Vault path and permissions |

## References

- [External Secrets Operator](https://external-secrets.io/)
- [Vault Kubernetes Auth](https://www.vaultproject.io/docs/auth/kubernetes)
- [ArgoCD](https://argo-cd.readthedocs.io/)
- [Vault Agent Injector](https://www.vaultproject.io/docs/platform/k8s/injector)
